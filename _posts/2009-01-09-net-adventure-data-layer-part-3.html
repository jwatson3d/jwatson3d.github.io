---

title: ".NET Adventure - Data Layer (part 3)"
date: '2009-01-09T06:17:00.001-05:00'
author: John
tags:
- Patterns
- Tutorial
- OSS
modified_time: '2010-09-05T22:05:40.913-04:00'
thumbnail: http://lh3.ggpht.com/_BvH8o_BvG-4/TIRIBwsfUNI/AAAAAAAAAJE/7TICb784E6M/s72-c/NAdv.FxCop.rules_thumb1.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-2811308028656623966.post-171531240631780509
blogger_orig_url: http://pragmatic-software.blogspot.com/2009/01/net-adventure-data-layer-part-3.html
---

This post is part of a <a href="http://blog.wrbsoftware.com/archive/2009/01/02/building-a-complex-.net-application.aspx">series</a> on building a complex .NET application from scratch. In <a href="http://blog.wrbsoftware.com/archive/2009/01/07/.net-adventure-data-layer-part-2.aspx">Part 2</a>, I introduced the Enterprise Library configuration and as well as unit testing with NUnit. Today I'm going to cover static code analysis using <a href="http://msdn.microsoft.com/en-us/library/bb429476.aspx" target="_blank">FxCop</a> and add <a href="http://nant.sourceforge.net/" target="_blank">NAnt</a> to the mix.<br /><br /><a href="http://lh4.ggpht.com/_BvH8o_BvG-4/TIRIBn8pAhI/AAAAAAAAAJA/JW-luKk7Hmc/s1600-h/NAdv.FxCop.rules3.png"><img align="right" alt="NAdv.FxCop.rules" border="0" height="244" src="http://lh3.ggpht.com/_BvH8o_BvG-4/TIRIBwsfUNI/AAAAAAAAAJE/7TICb784E6M/NAdv.FxCop.rules_thumb1.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; margin: 0px 0px 0px 10px;" width="209" /></a> FxCop is a free tool that will analyze your code using a comprehensive set of rules grouped into nine different categories shown on the right. When I first threw together the code for this project and ran FxCop it immediately showed me all the bad habits I had - improper casing of fields vs. properties and method arguments, etc. Within a couple of minutes I had refactored things and brought the list down to just one - not having my assembly signed which I can live with for now. In fact, running it against a large project I'm involved with at my day gig turned up 450+ errors and warnings! To be fair, that project has had a lot of cooks in the kitchen and everyone has their idea of the One-True-Wayâ„¢ when it comes to coding styles ;) That's the beauty of FxCop - it levels the playing field by not being emotional or stuck-in-the-mud about how things should be. The default rules it ships with are the accumulated best practices and standards employed by the Microsoft .NET engineers - talk about going straight to the source! Of course, you can edit the rules to change or disable ones you disagree with - however, my pragmatic side opted to conform so they're all on.<br /><br /><a href="http://lh6.ggpht.com/_BvH8o_BvG-4/TIRICUiQESI/AAAAAAAAAJI/FU2YdsLGAFI/s1600-h/NAdv.FxCop.results7.png"><img align="right" alt="NAdv.FxCop.results" border="0" height="139" src="http://lh3.ggpht.com/_BvH8o_BvG-4/TIRIDo7chNI/AAAAAAAAAJM/INGGM2FvBys/NAdv.FxCop.results_thumb3.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; margin: 0px 0px 0px 10px;" width="244" /></a> FxCop runs as a stand alone GUI where you simply reference "target" DLLs for it to analyze - I think of them as victims which it will mercilessly rip through exposing all their weaknesses. It also ships with a command line driver called FxCopCmd if you wish to invoke it from the command line - more on that in a moment. The main window is shown on the right with my one lonely violation remaining. Step back for a moment and consider what we have...a free tool with hundreds of pre-installed rules that will analyze your code, report the results complete with detailed information about the problem so you can write better code. 'Nuff said.<br /><br />So far we've got a Visual Studio project for data access and two free, open source tools to make our code better, our lives easier and reduce the federal deficit. Ok, maybe not the last one. One issue us lazy developers need to overcome is...well, being lazy. Right now, we've got to remember to run these tools. But, wait! Before you pick up that phone to call we've got one more special gift for you...<br /><br /><a href="http://nant.sourceforge.net/" target="_blank">NAnt</a> is a free .NET build tool originally based on Apache's Ant tool for Java. It uses an XML configuration file to define build projects that can be executed from the command line. Where it shines is that we can continue to develop/debug/compile in the Visual Studio IDE but when we think we're ready to go we can use NAnt to run all the steps and tools without batting an eye and both hands tied behind its back. NAnt uses the notion of targets and tasks and has...you guessed it, a bunch of tasks already set up. For our purposes, it can launch MSBuild to compile the project the same as Visual Studio does, then launch NUnit to execute all our unit tests and finally run FxCop to make sure our code is clean, polished and ready for showing off.<br /><br />Since NAnt is a mature tool there's plenty of information to be found by searching around and even a good book called <a href="http://www.amazon.com/Expert-Delivery-Using-CruiseControl-NET-ebook/dp/B001D7COTO?ie=UTF8&amp;tag=wsl-20&amp;link_code=btl&amp;camp=213689&amp;creative=392969" target="_blank">Expert .NET Delivery Using NAnt and CruiseControl.NET</a><img alt="" border="0" height="1" src="http://www.assoc-amazon.com/e/ir?t=wsl-20&amp;l=btl&amp;camp=213689&amp;creative=392969&amp;o=1&amp;a=B001D7COTO" style="border: none !important; margin: 0px !important; padding: 0px !important;" width="1" />&nbsp;if you really want to delve in. Rather than going through the scripts line-by-line I'm going to hit the high points and techniques I use.<br />Organization: <br /><ul><li>Use a nant.cmd batch script to handle validation, setup and avoid having to remember the command line switches<br /></li><li><a href="http://lh6.ggpht.com/_BvH8o_BvG-4/TIRID_zyzfI/AAAAAAAAAJQ/PwuOhNkRBhI/s1600-h/NAdv.NAnt.invoke3.png"><img align="right" alt="NAdv.NAnt.invoke" border="0" height="117" src="http://lh5.ggpht.com/_BvH8o_BvG-4/TIRIEJokL2I/AAAAAAAAAJU/pLyEFpmeoTE/NAdv.NAnt.invoke_thumb1.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; margin: 0px 0px 0px 5px;" width="244" /></a>Use a main (or "driver") build script, called NAdv.build that sits in the solution root folder. Note that many folks like to change the default extension to .xml since it is in fact an Xml file. I prefer the default .build extension as I know instantly that it is the NAnt build script and that it is unique and special, not just some dumb old Xml file laying around in the folder tree.<br /></li><li>The main build script should setup all the properties and paths then use the &lt;nant...&gt; task to drive individual build scripts in the project subdirectories (e.g. NAdv.DataLayer.build). This gives you cleaner organization and manageability as well as allowing each project to be tailored accordingly.<br /></li><li><a href="http://lh5.ggpht.com/_BvH8o_BvG-4/TIRIESQ3N-I/AAAAAAAAAJY/7xh5Rf7YvEg/s1600-h/NAdv.NAnt.help3.png"><img align="right" alt="NAdv.NAnt.help" border="0" height="66" src="http://lh4.ggpht.com/_BvH8o_BvG-4/TIRIEldhsBI/AAAAAAAAAJc/D6EIEQ-kNLo/NAdv.NAnt.help_thumb1.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; margin: 0px 0px 0px 10px;" width="244" /></a>Within a build script make a target called "help" <u>AND MAKE THIS THE DEFAULT</u>. An example output is shown on the right. <em>&lt;rant&gt;I *hate* it when someone sets up an environment where you simply type in "nant" and all kinds of things start happening while the console scrolls by faster than the blink of an eye. I always think to myself "Uh-oh, what just happened. Did it build? Did it deploy and overwrite something?"&lt;/rant&gt;</em> It is much safer to show the help settings when someone types in "nant" and make them use an explicit build target (e.g. "nant build" or "nant deploy") - an intentional choice of what they wish to do.<br /></li><li><a href="http://lh4.ggpht.com/_BvH8o_BvG-4/TIRIFA3HG5I/AAAAAAAAAJg/Z4hLuts4c_M/s1600-h/NAdv.NAnt.exec3.png"><img align="right" alt="NAdv.NAnt.exec" border="0" height="139" src="http://lh6.ggpht.com/_BvH8o_BvG-4/TIRIFWsgmDI/AAAAAAAAAJk/4rbvVKLgUuE/NAdv.NAnt.exec_thumb1.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; margin: 5px 0px 0px 5px;" width="244" /></a>Make "main" target names a single word, e.g. clean, build, deploy, and have these targets call "internal" sub-targets that are compound words, e.g. build.init, build.compile, deploy.web, deploy.database.<br /></li><li>Don't launch NUnit using NAnt's built-in &lt;nunit2&gt; task - use the generic &lt;exec&gt; task to run NUnit's console. NAnt and NUnit are different projects on different release schedules and NAnt is compiled against the version of NUnit that was available at the time it was built - NUnit 2.2.8 at the time of this writing. Using &lt;exec&gt; allows you to run the latest version of NUnit directly the same as when you do so interactively from the Visual Studio IDE.</li></ul>One issue that comes up attempting to use the &lt;msbuild&gt; task to driving compiling the projects is that an Import entry is referenced incorrectly:<br /><div class="csharpcode"><pre class="alt"><span class="lnum">   1:  </span>Change the following line in *.csproj:</pre><pre><span class="lnum">   2:  </span>  <span class="kwrd">&lt;</span><span class="html">Import</span> <span class="attr">Project</span><span class="kwrd">="$(MSBuild<b>Tools</b>Path)\Microsoft.CSharp.targets"</span> <span class="kwrd">/&gt;</span></pre><pre class="alt"><span class="lnum">   3:  </span>To the following:</pre><pre><span class="lnum">   4:  </span>  <span class="kwrd">&lt;</span><span class="html">Import</span> <span class="attr">Project</span><span class="kwrd">="$(MSBuild<b>Bin</b>Path)\Microsoft.CSharp.targets"</span> <span class="kwrd">/&gt;</span></pre></div><br />Here's what the output of running "nant fxcop" looks like on the console:<br /><a href="http://lh4.ggpht.com/_BvH8o_BvG-4/TIRIFh5Zr0I/AAAAAAAAAJo/VhOCHcKwgDc/s1600-h/NAdv.Nant.fxcop2.png"><img alt="NAdv.Nant.fxcop" border="0" height="242" src="http://lh4.ggpht.com/_BvH8o_BvG-4/TIRIF4Rw_7I/AAAAAAAAAJs/1WdWB0sapcY/NAdv.Nant.fxcop_thumb.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="244" /></a> <br /><br />The FxCop results can be directed to an Xml file that contains formatting which looks like this:<br /><a href="http://lh5.ggpht.com/_BvH8o_BvG-4/TIRIGYiTeII/AAAAAAAAAJw/Vvi562DZH_Q/s1600-h/NAdv.FxCop.resultsxml2.png"><img alt="NAdv.FxCop.results-xml" border="0" height="203" src="http://lh4.ggpht.com/_BvH8o_BvG-4/TIRIGoeZhrI/AAAAAAAAAJ0/0w59dpplRhg/NAdv.FxCop.resultsxml_thumb.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="244" /></a> <br /><br />The code for this version of the project can be downloaded from <a href="https://docs.google.com/a/wrbsoftware.com/uc?id=0B0Ogd3bGXPjJZjc1MjY1OWItY2I4OC00NzFhLTg4YmQtMWU1NTk0NWQyMTQx&amp;export=download&amp;authkey=CKnzmooD&amp;hl=en" target="_blank">here</a>. Note a couple of changes - the build output has been "tweaked" to NAdv_vX.X\bin which is "above" the source and test trees and the NAnt, NUnit and FxCop configurations/settings files are now included. If you unpack the zip file then open a command prompt in NAdv_vX.X (1.2 in this case) you should be able to execute "nant build, nant fxcop, and nant test" to execute all three targets. If you have problems, first check the console output and the log files and leave a comment if you're still stuck.