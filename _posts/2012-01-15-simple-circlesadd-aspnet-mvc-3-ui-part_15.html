---
title: Simple Circles–Add an ASP.NET MVC 3 UI (Part 4b)
date: '2012-01-15T10:37:00.000-05:00'
author: John
classes: wide
excerpt: In the last post I left off with a scaffolded People MVC implementation that was hard-wired to use the Entity Framework 4 data access technology. In this post I’m going to replace that with the Ninject dependency-injection framework and use the previously built FakePartyRepository implementation to begin testing the UI quickly...
tags:
- CodeGeneration
- Patterns
- MVC
- Tutorial
- ASP.NET 4.0
- OSS
modified_time: '2012-01-15T16:22:47.764-05:00'
thumbnail: http://lh4.ggpht.com/-Skk1Y1gLNIU/TwJpiSZkdcI/AAAAAAAAAaU/W-VWg3hX0dc/s72-c/Simple%252520Circles%252520-%252520Ninject%252520package_thumb.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-2811308028656623966.post-372856165361446432
blogger_orig_url: http://pragmatic-software.blogspot.com/2012/01/simple-circlesadd-aspnet-mvc-3-ui-part_15.html
---

This post is part of a <a href="http://pragmatic-software.blogspot.com/2012/01/simple-circlesintroduction.html">series</a> on building a simple to use web-based contact and customer relationship management application. The goal is to support various audiences including businesses, teams, clubs, religious organizations, etc.<br /><a href="http://lh4.ggpht.com/-jP08VRDvUo4/TwPFVB80BSI/AAAAAAAAAaM/v8YkxyqqxfE/s1600-h/Simple%252520Circles%252520-%252520Ninject%252520package.png"><img align="right" alt="Simple Circles - Ninject package" border="0" height="141" src="http://lh4.ggpht.com/-Skk1Y1gLNIU/TwJpiSZkdcI/AAAAAAAAAaU/W-VWg3hX0dc/Simple%252520Circles%252520-%252520Ninject%252520package_thumb.png?imgmax=800" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; float: right; margin: 0px 0px 0px 5px; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="Simple Circles - Ninject package" width="192" /></a>In the <a href="http://pragmatic-software.blogspot.com/2012/01/simple-circlesadd-aspnet-mvc-3-ui-part.html">last post</a> I left off with a scaffolded People MVC implementation that was hard-wired to use the Entity Framework 4 data access technology. In this post I’m going to replace that with the <a href="http://ninject.org/" target="_blank">Ninject</a> dependency-injection framework and use the previously built FakePartyRepository implementation to begin testing the UI quickly.<br />With NuGet, adding Ninject support is easy – just two simple commands: ‘<span style="font-family: 'Courier New';">Install-Package Ninject -Version 2.2.1.4</span>’ and ‘<span style="font-family: 'Courier New';">Install-Package Ninject.MVC3 -Version 2.2.2.0</span>’. I chose to include specific versions since they were specified on the corresponding NuGet Gallery pages. Once again there is a lot going on behind the scene as shown to the right.<br /><a href="http://lh5.ggpht.com/-DwSaTJXHhv4/TwJpivFUDwI/AAAAAAAAAaY/XU3-7hww38M/s1600-h/Simple%252520Circles%252520-%252520Ninject.MVC3.png"><img align="right" alt="Simple Circles - Ninject.MVC3" border="0" height="181" src="http://lh5.ggpht.com/-pVHmm1sk_xU/TwJpi8JXKEI/AAAAAAAAAac/7wAVchovsMg/Simple%252520Circles%252520-%252520Ninject.MVC3_thumb.png?imgmax=800" style="background-image: none; border-bottom: 0px; border-left: 0px; border-right: 0px; border-top: 0px; display: inline; float: right; margin: 0px 0px 0px 5px; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="Simple Circles - Ninject.MVC3" width="185" /></a>The <a href="https://github.com/ninject/ninject.web.mvc/wiki/MVC3" target="_blank">Ninject.MVC3 extension</a> was created to add support to MVC 3 applications including DI for Controllers, filters, validators and the Unit of Work pattern for NHibernate (more on this later!). The NuGet version adds a class to the \App_Start folder called NinjectMVC3 wired and ready to go. It does so by hooking in with the WebActivator project – one of the dependencies automatically installed when the Ninject.MVC3 package was installed.<br /><h2>   Controller</h2>First I’ll add references to the Domain and Persistence projects to bring in their type definitions then I’ll replace the EF context reference in PeopleController with the IPartyRepository instead. Refer to the last screenshot in the previous post to see the boilerplate code generated by the scaffolding.<br /><pre class="c-sharp" name="code">public class PeopleController : Controller<br />{<br />  private readonly IPartyRepository repository;<br /><br />  public PeopleController(IPartyRepository repository)<br />  {<br />    this.repository = repository;<br />  }<br /><br />  public ViewResult Index()<br />  {<br />    IEnumerable&lt;Domain.Person&gt; persons = this.repository.FindAllPersons();<br />    return View(persons);<br />  }<br />  ...</pre><br />The problem with the above code is that it will not compile because of line 13 – ‘<span style="font-family: 'Courier New';">return View(persons)</span>’. The MVC convention is to use separate model classes in the presentation layer to decouple it from the business/domain layer. I did exactly this when creating a Person class in the \Models folder - essentially flattening the <span style="font-family: 'Courier New', Courier, monospace;">EntityBase</span>-&gt;<span style="font-family: 'Courier New', Courier, monospace;">Entity</span>-&gt;<span style="font-family: 'Courier New', Courier, monospace;">Party</span>-&gt;<span style="font-family: 'Courier New', Courier, monospace;">Person</span> inheritance hierarchy to just <span style="font-family: 'Courier New', Courier, monospace;">Person</span>. The scaffolding constructed the views (Index, Details, Edit, etc.) to work with the <span style="font-family: 'Courier New', Courier, monospace;">Models.Person</span> class – not the <span style="font-family: 'Courier New', Courier, monospace;">Domain.Person</span>. Line 12 is returning an enumeration of <span style="font-family: 'Courier New', Courier, monospace;">Domain.Person</span> instances whereas the view expects <span style="font-family: 'Courier New', Courier, monospace;">Models.Person</span> instances.<br /><br /><h2>   Data Mapper</h2><br />The solution to this mismatch lies in another tool called <a href="http://automapper.org/" target="_blank">AutoMapper</a> which makes using the <a href="http://martinfowler.com/eaaCatalog/dataMapper.html" target="_blank">Data Mapper</a> pattern a cinch. Jeremy Miller’s MSDN article <a href="http://msdn.microsoft.com/en-us/magazine/dd569757.aspx#id0400052" target="_blank">Persistence Patterns</a> gives a good overview of how these various proven patterns fit and work together. Also, Jimmy Bogard wrote a <a href="http://lostechies.com/jimmybogard/category/automapper/" target="_blank">series of articles</a> on his tool at Los Techies. Back to the NuGet Package Manager console to ‘<span style="font-family: 'Courier New';">Install-Package AutoMapper</span>’.<br /><br />I created a <span style="font-family: 'Courier New', Courier, monospace;">\Maps</span> folder and added a new class called <span style="font-family: 'Courier New', Courier, monospace;">PersonMap</span> to define the mapping back and forth between the two models…  <br /><pre class="c-sharp" name="code">internal class PersonMap<br />{<br />  internal static void CreateMaps()<br />  {<br />    Mapper.CreateMap&lt;Domain.Person, Models.Person&gt;()<br />        .ForMember(dest =&gt; dest.Birthday, opt =&gt; opt.MapFrom(src =&gt; src.Birthday))<br />        .ForMember(dest =&gt; dest.FirstName, opt =&gt; opt.MapFrom(src =&gt; src.FirstName))<br />      ...<br />        .ForMember(dest =&gt; dest.PersonId, opt =&gt; opt.MapFrom(src =&gt; src.PartyId))<br />        .ForMember(dest =&gt; dest.FullName, opt =&gt; opt.MapFrom(src =&gt; src.PartyName))<br />        .ForMember(dest =&gt; dest.Salutation, opt =&gt; opt.MapFrom(src =&gt; src.Salutation ?? null))<br />        .ForMember(dest =&gt; dest.Suffix, opt =&gt; opt.MapFrom(src =&gt; src.Suffix ?? null));<br /><br />    Mapper.CreateMap&lt;Models.Person, Domain.Person&gt;()<br />        .ForMember(dest =&gt; dest.ChannelAddresses, opt =&gt; opt.Ignore())<br />        .ForMember(dest =&gt; dest.Birthday, opt =&gt; opt.MapFrom(src =&gt; src.Birthday))<br />        .ForMember(dest =&gt; dest.FirstName, opt =&gt; opt.MapFrom(src =&gt; src.FirstName))<br />      ...<br />        .ForMember(dest =&gt; dest.PartyId, opt =&gt; opt.MapFrom(src =&gt; src.PersonId))<br />        .ForMember(dest =&gt; dest.PartyName, opt =&gt; opt.Ignore())<br />        .ForMember(dest =&gt; dest.PartyType, opt =&gt; opt.Ignore())<br />        .ForMember(dest =&gt; dest.PostalAddresses, opt =&gt; opt.Ignore())<br />        .ForMember(dest =&gt; dest.Salutation, opt =&gt; opt.MapFrom(src =&gt; src.Salutation ?? null))<br />        .ForMember(dest =&gt; dest.Suffix, opt =&gt; opt.MapFrom(src =&gt; src.Suffix ?? null));<br />  }<br />}</pre>A few things are worth pointing out in the above listing:<br /><ol><br /><li>Line #9 shows how I map the generic, internal <span style="font-family: 'Courier New', Courier, monospace;">PartyId</span> from the domain model to the more friendly and meaningful <span style="font-family: 'Courier New', Courier, monospace;">PersonId</span> in the MVC layer. </li><li>Line #10 does the same for the <span style="font-family: 'Courier New', Courier, monospace;">PartyName</span> - mapping it to a <span style="font-family: 'Courier New', Courier, monospace;">FullName</span> property. </li><li>Line #15 tells the mapper to ignore the <span style="font-family: 'Courier New', Courier, monospace;">ChannelAddress</span> property in the domain model – it will not be mapped to the MVC layer. The same goes for <span style="font-family: 'Courier New', Courier, monospace;">PostalAddresses </span>&nbsp;–&nbsp;&nbsp;these will be dealt with later and in a manner appropriate for the user interface.</li><li>Lines #11, #12, #23, #24 show how optional fields are handled.</li></ol><br />A call to <span style="font-family: 'Courier New', Courier, monospace;">PersonMap.CreateMaps()</span> in <span style="font-family: 'Courier New', Courier, monospace;">Global.asax.cs</span> will initialize the maps when the website starts up. To use the maps, add a line to invoke the data mapping like this:<br /><pre class="c-sharp" name="code">[HttpPost]<br />public ActionResult Create(Person person)<br />{<br />  if (!ModelState.IsValid)<br />  {<br />    return View(person);<br />  }<br /><br />  var entity = Mapper.Map&lt;Person, Domain.Person&gt;(person);<br /><br />  this.repository.Add(entity);<br /><br />  return RedirectToAction("Index");<br />}</pre><br />Line #9 is the magic – transferring the contents of the MVC <span style="font-family: 'Courier New', Courier, monospace;">Models.Person</span> to the <span style="font-family: 'Courier New', Courier, monospace;">Domain.Person</span> before passing to the repository to store.<br /><br /><h2>   Dependency Injection</h2><br />The <span style="font-family: 'Courier New', Courier, monospace;">PeopleController</span> at the top of this article used constructor injection on Line #5 to receive an <span style="font-family: 'Courier New', Courier, monospace;">IPartyRepository</span> instance. Following the Ninject samples and documentation, I’ve added a <span style="font-family: 'Courier New', Courier, monospace;">\Services\ServicesModule</span> which inherits from <span style="font-family: 'Courier New', Courier, monospace;">NinjectModule</span> to handle the injection of services:<br /><pre class="c-sharp" name="code">/// &lt;summary&gt;<br />/// A Ninject module to bind services.<br />/// &lt;/summary&gt;<br />public class ServicesModule : NinjectModule<br />{<br />  /// &lt;summary&gt;<br />  /// Called when the module loads into the kernel.<br />  /// &lt;/summary&gt;<br />  public override void Load()<br />  {<br />    this.Bind&lt;IPartyRepository&gt;()<br />        .To&lt;FakePartyRepository&gt;()<br />        .InRequestScope();<br />  }<br />}</pre><br />To wire up the module, add a line to the RegisterServices method found in <span style="font-family: 'Courier New', Courier, monospace;">NinjectMVC3</span>:<br /><pre class="c-sharp" name="code">private static void RegisterServices(IKernel kernel)<br />{<br />  kernel.Load&lt;Services.ServicesModule&gt;();<br />}</pre><br />The end result of this effort is that I can now browse and display the list of persons as shown here:<br /><br /><a href="http://lh5.ggpht.com/-2azF5zHQc44/TwJpjALedQI/AAAAAAAAAag/l4RTcZZ0PY4/s1600-h/Simple-Circles---MVC-with-Fake-Repo3.png"><img alt="Simple Circles - MVC with Fake Repo" border="0" height="227" src="http://lh6.ggpht.com/-T4H8QONKceY/TwJpjVj2bII/AAAAAAAAAak/2V5v4zscgsM/Simple-Circles---MVC-with-Fake-Repo_.png?imgmax=800" style="background-image: none; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: inline; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="Simple Circles - MVC with Fake Repo" width="308" /></a><br /><br />Next time I’ll set up a unit test to exercise the functionality of the controller through injection so that I won’t have to always manually hit every view/page to see if it still works as changes are made.<br /><br />The source code for this article can be downloaded from <a href="http://simplecircles.codeplex.com/SourceControl/changeset/changes/b1ab47954e15" target="_blank">here</a>.
