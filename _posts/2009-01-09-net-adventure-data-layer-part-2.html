---

title: ".NET Adventure - Data Layer (part 2)"
date: '2009-01-09T06:12:00.001-05:00'
author: John
tags:
- Patterns
- Tutorial
- OSS
modified_time: '2010-09-05T22:00:44.308-04:00'
thumbnail: http://lh5.ggpht.com/_BvH8o_BvG-4/TIRHlr5C02I/AAAAAAAAAIU/pewLHgEuYfU/s72-c/NAdv.DataLayer_entlib.refs_thumb.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-2811308028656623966.post-3891656844199773295
blogger_orig_url: http://pragmatic-software.blogspot.com/2009/01/net-adventure-data-layer-part-2.html
---

This post is part of a <a href="http://blog.wrbsoftware.com/archive/2009/01/02/building-a-complex-.net-application.aspx">series</a> on building a complex .NET application from scratch. In <a href="http://blog.wrbsoftware.com/archive/2009/01/05/21.aspx">Part 1</a>, I introduced the Active Record pattern used to create data layer components. Today I'm going to wrap-up what I started by covering the Enterprise Library configuration, unit testing with NUnit and static code analysis using FxCop.<br />Microsoft's <a href="http://msdn.microsoft.com/en-us/library/cc467894.aspx" target="_blank">Enterprise Library</a> "is a collection of reusable software components (application blocks) designed to assist software developers with common enterprise development challenges." Referring to the previous Common Application Architecture <a href="http://www.blogger.com/Images/88e8e9544f5b.NETAdventureIntroduction_1177C/RefAppArch.png" target="_blank" title="Reference Application Architecture">diagram</a>, the "EntLib" would be placed on the far right as a "cross-cutting" technology. To begin with, I'm using it solely to provide low-level data access. At a minimum, you need to add a project references to the EntLib components, configure a data source and add code to use it.<br /><br />For the data access references there is a standard Common library, a utility library called ObjectBuilder2, and the Data Access library:<br /><a href="http://lh5.ggpht.com/_BvH8o_BvG-4/TIRHk7d9aMI/AAAAAAAAAIQ/iZ9mmTWk93o/s1600-h/NAdv.DataLayer_entlib.refs2.png"><img alt="NAdv.DataLayer_entlib.refs" border="0" height="114" src="http://lh5.ggpht.com/_BvH8o_BvG-4/TIRHlr5C02I/AAAAAAAAAIU/pewLHgEuYfU/NAdv.DataLayer_entlib.refs_thumb.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="244" /></a> <br /><br />Note that ObjectBuilder2 is new with version 4.x and was delivered as part of the Unity application block - more on that later. EntLib installs a custom Visual Studio designer as well as a standalone configuration editor. However, since we're using the Express Editions of Visual Studio and add-ins are not supported (hey, it's free!) the integrated designer doesn't work but we can use the standalone editor as shown here:<br /><a href="http://lh4.ggpht.com/_BvH8o_BvG-4/TIRHl0Dg3II/AAAAAAAAAIY/wZTZfVWTsVQ/s1600-h/NAdv.EntLib_config2.png"><img alt="NAdv.EntLib_config" border="0" height="119" src="http://lh6.ggpht.com/_BvH8o_BvG-4/TIRHm-A-QpI/AAAAAAAAAIc/ZccVyrAcgOc/NAdv.EntLib_config_thumb.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="244" /></a>&nbsp; <br /><br />Simply launch the standalone editor from the Start menu shortcut and open the configuration file. Because .NET's app.config and web.config files can become "busy" with too many options, I prefer to use the EntLib feature of storing it's configuration in a separate file called "EntLib.config" that is referenced from the app.config:<br /><a href="http://lh3.ggpht.com/_BvH8o_BvG-4/TIRHnNBOgAI/AAAAAAAAAIg/aZWcXqzYslA/s1600-h/NAdv.DataLayer_app.config2.png"><img alt="NAdv.DataLayer_app.config" border="0" height="102" src="http://lh6.ggpht.com/_BvH8o_BvG-4/TIRHn-8apxI/AAAAAAAAAIk/JMsC_uTuBrw/NAdv.DataLayer_app.config_thumb.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="244" /></a><br /><br />Notice above that only one new section was added to app.config and in that section is the reference to the standalone EntLib configuration file - nothing else is needed there.<br /><br />For completeness, here's the full EntLib.conf file as it exists at the moment:<br /><a href="http://lh5.ggpht.com/_BvH8o_BvG-4/TIRHocjvd7I/AAAAAAAAAIo/_y-WsqGIPmo/s1600-h/NAdv.DataLayer_entlib.config2.png"><img alt="NAdv.DataLayer_entlib.config" border="0" height="134" src="http://lh3.ggpht.com/_BvH8o_BvG-4/TIRHooRAqlI/AAAAAAAAAIs/KUcrNILfPYI/NAdv.DataLayer_entlib.config_thumb.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="244" /></a>&nbsp; <br /><br />To test this code we can turn to <a href="http://nunit.org/" target="_blank">NUnit</a>. Again, I'll say the goal of this series isn't to drill so deeply in one technology but rather to pull together various technologies into an end-to-end working application. Marc Clifton wrote a series of articles on <a href="http://www.marcclifton.com/tabid/87/Default.aspx" target="_blank">Unit Test Patterns</a> that is a good introduction to just how far one can go in designing and preparing tests. Suffice to say that this is a topic unto itself and that the tests I've shown are far from complete - more along the lines of simple black-box pass/fail tests. My goal was to lay the groundwork for testing the data layer and show how the layered architecture lends itself to this kind of quality, professional development that delivers resilient code. Using a testing framework/harness and some code you can immediately exercise the layer with relatively little effort.<br /><br /><a href="http://lh3.ggpht.com/_BvH8o_BvG-4/TIRHoxajXsI/AAAAAAAAAIw/lYabywCkPjQ/s1600-h/NAdv.UnitTests.references3.png"><img align="right" alt="NAdv.UnitTests.references" border="0" height="244" src="http://lh6.ggpht.com/_BvH8o_BvG-4/TIRHpM_hlvI/AAAAAAAAAI0/pPNodSF3jtA/NAdv.UnitTests.references_thumb1.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="235" /></a>Since NUnit is a test harness or "driver application" that runs tests, you simply need to create standard .NET class libraries with classes that publicly expose the tests you wish to make available. As a starting point, you should at least write a test for each publicly exposed method that can be called externally. The testing assembly needs a reference to the NUnit.Framework assembly as well as your own projects that you'll be testing as shown here on the right.<br /><br />You'll notice that I've also created an app.config and EntLib.config file here in the unit test assembly. While testing code, this assembly will be the controlling application so any references to configuration data will be found here in this project and not in the "lower-level" project being tested - the NAdv.DataLayer in this example. In fact, the configuration examples shown above were actually from the UnitTests project and not the DataLayer project!<br /><br />Here's some simple code to test adding a new customer:<br /><pre class="csharp" name="code">[TestFixture]<br />  public class CustomerTest<br />  {<br />    [Test]<br />    public void AddCustomer()<br />    {<br />      Customer customer = new Customer();<br />      SetCustomerValues(customer);<br />      int customerId = customer.Store();<br />    }<br /><br />    ... &lt;snip&gt; ...<br />     <br />    private void SetCustomerValues(Customer customer)<br />    {<br />       string timestamp = DateTime.Now.Ticks.ToString();<br /><br />       customer.CompanyName = "AdventureWorks Unit Test " + timestamp;<br />       customer.EmailAddress = timestamp + "@adventureworks.com";<br />       customer.FirstName = "Unit";<br />       customer.LastName = "Test";<br />       customer.MiddleName = "A.";<br />       customer.NameStyle = NameStyleValue.Western;<br />       customer.PasswordHash = "L/Rlwxzp4w7RWmEgXX+/A7cXaePEPcp+KwQhl2fJL7w=";<br />       customer.PasswordSalt = "1KjXYs4=";<br />       customer.Phone = "1234567890";<br />       customer.Salesperson = "Salesperson " + timestamp;<br />       customer.Suffix = "Jr.";<br />       customer.Title = "Mr.";<br />    }<br />  }<br /></pre><br />The [TestFixture] and [Test] attributes are NUnit's way of marking a class and method, respectively, to indicate that they are test code which it should execute. The AddCustomer() method is public, accepts no parameters and returns nothing to the caller (NUnit). The essence of the test is to construct an instance of the Customer class, set all the properties, and call the Store() method. While this is a contrived, hard-coded example it does show how little effort it takes to begin writing unit tests.<br /><br />Because we're using the Express Editions of Visual Studio, some functionality is limited including the ability to configure custom debugging settings. In fact, the default installation shows a "basic" set of configuration settings on a project. You must use Tools | Options on the VS menu then select "Projects and Solutions" and check the "Show advanced build configurations" to be able to switch from Release to Debug builds or see additional project configuration options. Even after doing this you won't be able to specify the NUnit GUI as the application to launch when debugging. However, if you add the following two lines to the *.csproj file for your unit test project:<br /><pre class="html" name="code">&lt;StartAction&gt;Program&lt;/StartAction&gt;<br />&lt;StartProgram&gt;C:\NUnit 2.4.8\bin\nunit.exe&lt;/StartProgram&gt;<br /></pre>within the &lt;PropertyGroup&gt; for the Debug configuration you'll be able to press 'F5' to start debugging and the NUnit GUI will launch. Now, because the Visual Studio debugger has launched you can set breakpoints in your code and step through it just like the "big boys" do using Professional and Team editions.<br /><br /><a href="http://lh4.ggpht.com/_BvH8o_BvG-4/TIRHpWA6zQI/AAAAAAAAAI4/HxcgkSuA4d0/s1600-h/NAdv.UnitTests.DataLayer_run2.png"><img alt="NAdv.UnitTests.DataLayer_run" border="0" height="132" src="http://lh6.ggpht.com/_BvH8o_BvG-4/TIRHp5X68SI/AAAAAAAAAI8/Uo_yi__B-OM/NAdv.UnitTests.DataLayer_run_thumb.png?imgmax=800" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="244" /></a> <br /><br />Above is the NUnit GUI showing the unit tests I've set up and run. Of course, the Zen of unit testing and TDD requires you to design your tests and APIs before ever writing a line of code - I won't lie to you and say I wrote these tests beforehand ;)<br /><br />Since this post is already getting long, I don't want to set a trend so I'll stop here and discuss FxCop in the next post. The code for this version of the project can be downloaded from <a href="https://docs.google.com/a/wrbsoftware.com/uc?id=0B0Ogd3bGXPjJYzA5ZjY2MWYtOTQ5OS00NjRhLTkwYTktYzRmZWYxM2ZkNTlj&amp;export=download&amp;authkey=CNO7_6sJ&amp;hl=en">here</a>.