---
layout: post
title: Simple Circles–Fake Repository (Part 3)
date: '2012-01-09T06:00:00.000-05:00'
author: John
tags:
- Patterns
- Tutorial
- TDD
- OSS
modified_time: '2012-01-09T06:00:11.706-05:00'
thumbnail: http://lh4.ggpht.com/-oIZQygx-F9k/TwEO__vv5JI/AAAAAAAAAYU/6fiOBNnCIcI/s72-c/Simple%252520Circles%252520-%252520xunit_thumb.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-2811308028656623966.post-764387060054367382
blogger_orig_url: http://pragmatic-software.blogspot.com/2012/01/simple-circlesfake-repository-part-3.html
---

<p>This post is part of a <a href="http://pragmatic-software.blogspot.com/2012/01/simple-circlesintroduction.html">series</a> on building a simple to use web-based contact and customer relationship management application. The goal is to support various audiences including businesses, teams, clubs, religious organizations, etc. With a basic structure for the domain objects taking shape it’s time to move on to the notion of persistence.</p> <p>In the last post I set up the interfaces to support the Repository pattern and left off with the following signature:</p><pre class="c-sharp" name="code">namespace Circles.Persistence<br />{<br />  using System;<br />  using System.Linq;<br /><br />  public interface IPartyRepository : IRepository&lt;Party, Guid&gt;, ISupportSave&lt;Party, Guid&gt;, ISupportDelete&lt;Party, Guid&gt;<br />  {<br />    IQueryable&lt;Household&gt; FindAllHouseholds();<br />    IQueryable&lt;Organization&gt; FindAllOrganizations();<br />    IQueryable&lt;Person&gt; FindAllPersons();<br />  }<br /></pre><br /><p>Now I’m going to put together a simple fake repository implementation to exercise the interfaces as well as quickly provide sample data to work with. I’ve added a new project called FakeRepository containing a single class called FakePartyRepository partly shown here:</p><pre class="c-sharp" name="code">namespace Circles.FakeRepository<br />{<br />  using System;<br />  using System.Collections.Generic;<br />  using System.Linq;<br /><br />  public class FakePartyRepository : IPartyRepository<br />  {<br />    private readonly List&lt;Household&gt; fakeHouseholdList = new List&lt;Household&gt; <br />    {<br />      new Household { PartyName = "Churchill", FormalGreeting = "Sir Winston and Lady Clementine" },<br />      new Household { PartyName = "Roosevelt", FormalGreeting = "President Franklin and Mrs. Eleanor" },<br />    };<br /><br />    private readonly List&lt;Organization&gt; fakeOrganizationList = new List&lt;Organization&gt; <br />    {<br />      new Organization { PartyName = "Great Lakes Food Market" },<br />      new Organization { PartyName = "Hungry Coyote Import Store" },<br />      new Organization { PartyName = "Lazy K Kountry Store" },<br />    };<br /><br />    private readonly List&lt;Person&gt; fakePersonList = new List&lt;Person&gt;<br />    {<br />      new Person { FirstName = "Nancy", LastName = "Davolio", Gender = GenderEnum.Female, Birthday = new DateTime(1948, 12, 8) },<br />      new Person { FirstName = "Andrew", LastName = "Fuller", Gender = GenderEnum.Male, Birthday = new DateTime(1992, 8, 14) },<br />    };<br /><br />    private readonly IQueryable&lt;Household&gt; fakeHouseholdRepository;<br />    private readonly IQueryable&lt;Organization&gt; fakeOrganizationRepository;<br />    private readonly IQueryable&lt;Person&gt; fakePersonRepository;<br />    private readonly IQueryable&lt;Party&gt; fakePartyRepository;<br /><br />    public FakePartyRepository()<br />    {<br />      this.fakeHouseholdRepository = this.fakeHouseholdList.AsQueryable();<br />      this.fakeOrganizationRepository = this.fakeOrganizationList.AsQueryable();<br />      this.fakePersonRepository = this.fakePersonList.AsQueryable();<br />      this.fakePartyRepository = this.fakeOrganizationList.Union<party>(this.fakePersonList).Union(this.fakeHouseholdList).AsQueryable();<br />    }<br /><br />    public IQueryable&lt;Party&gt; FindAll()<br />    {<br />      return this.fakePartyRepository;<br />    }<br /><br />    public Party FindById(Guid id)<br />    {<br />      return this.fakePartyRepository.FirstOrDefault(x =&gt; x.PartyId == id);<br />    }<br />  }<br /></pre><br /><p>As you can see, the underlying data is contained in simple in-memory generic Lists that are wrapped into LINQ IQueryable objects. Note the last line of the constructor where the fakePartyRepository is a .Union of the three underlying lists.</p><br /><p><a href="http://lh5.ggpht.com/-pGYdwMCzf64/TwEO9mflxcI/AAAAAAAAAYM/EJioYs4dFPE/s1600-h/Simple%252520Circles%252520-%252520xunit%25255B2%25255D.png"><img style="background-image: none; border-right-width: 0px; margin: 0px 0px 0px 5px; padding-left: 0px; padding-right: 0px; display: inline; float: right; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Simple Circles - xunit" border="0" alt="Simple Circles - xunit" align="right" src="http://lh4.ggpht.com/-oIZQygx-F9k/TwEO__vv5JI/AAAAAAAAAYU/6fiOBNnCIcI/Simple%252520Circles%252520-%252520xunit_thumb.png?imgmax=800" width="244" height="101"></a>To test the FakeRepository let’s add another class library project called UnitTests. We’ll use <a href="http://nuget.org/" target="_blank">NuGet</a> to add the <a href="http://xunit.codeplex.com/" target="_blank">xUnit</a> package with the command ‘<font face="Courier New">install-package xunit</font>’ as shown to the right. xUnit was created by James Newkirk (creator of the venerable NUnit) and Brad Wilson to better reflect the purpose of driving and iterating the design of an implementation at the unit level. Brad discusses this philosophy in his article <a href="http://bradwilson.typepad.com/blog/2009/04/its-not-tdd-its-design-by-example.html" target="_blank">Its not TDD, It’s Design by Example</a>. After adding the xUnit reference, add a class called PartyRepositoryTest:</p><pre class="c-sharp" name="code">  public class PartyRepositoryTest<br />  {<br />    [Fact]<br />    public void CanAddHousehold()<br />    {<br />      // arrange<br />      IPartyRepository repository = new FakePartyRepository();<br /><br />      // act<br />      var id = repository.Add(new Household<br />        {<br />          PartyName = "Eisenhower", <br />          FormalGreeting = "President Dwight D. and Mrs. Mamie", <br />          InformalGreeting = "Ike and Mamie"<br />        });<br /><br />      // assert<br />      Assert.NotNull(id);<br />      Assert.NotNull(repository.FindById(id));<br />    }<br />  }<br /></pre><br /><p>The first thing you may notice is that xUnit uses the attribute [Fact] rather than [Test] as other TDD frameworks do. As Brad puts it “a [Fact] is an expression of some condition which is invariant”. Essentially we’re saying that the condition “<em>CanAddHousehold</em>” is an invariant condition of the PartyRepository which must always be true. In addition to expressing facts, xUnit lets you express theories which are “an expression of a condition which is only necessarily true for the given set of data.”:</p><pre class="c-sharp" name="code">  [Theory,<br />  InlineData("D28AA45E-C650-4121-8070-3D12BE31F91A")]<br />  public void CanFindSinglePerson(string id)<br />  {<br />    // arrange<br />    IPartyRepository repository = new FakePartyRepository();<br />    var partyId = new Guid(id);<br /><br />    // act<br />    var person = repository.FindById(partyId) as Person;<br /><br />    // assert<br />    Assert.NotNull(person);<br />    Assert.True(person.Id == partyId);<br />  }<br /></pre><br /><p><a href="http://lh5.ggpht.com/-sGzPdeFJPSI/TwEO_8KEMWI/AAAAAAAAAYc/3ioQ0xMzhDQ/s1600-h/Simple%252520Circles%252520-%252520Unit%252520Tests%25255B2%25255D.png"><img style="background-image: none; border-right-width: 0px; margin: 0px 0px 0px 5px; padding-left: 0px; padding-right: 0px; display: inline; float: right; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Simple Circles - Unit Tests" border="0" alt="Simple Circles - Unit Tests" align="right" src="http://lh6.ggpht.com/-slLKXLplCUw/TwEPANVYHnI/AAAAAAAAAYk/6v0lODkXZG4/Simple%252520Circles%252520-%252520Unit%252520Tests_thumb.png?imgmax=800" width="214" height="244"></a>Since we built the FakeRepository with our known data, we can construct tests with known values to prove the repository is working as designed without defects. In the above example, we know the PartyId of one of the person instances that we put into the fake repository so we can attempt to retrieve that person to exercise that logic. <a href="http://www.jetbrains.com/resharper/" target="_blank">ReSharper</a>’s test runner shows all the tests we currently have. Before the tests can be compiled and run, you must add a reference to the Extensions subproject of xUnit which holds the [Theory] attribute definition and behavior. Once again, use the NuGet Package Manager Console to execute the command “<font face="Courier New">install-package xunit.extensions</font>”.</p><br /><p>Finally, you’ll notice in the above samples as well as the source code accompanying this post that I’ve followed the “3A” or “<a href="http://c2.com/cgi/wiki?ArrangeActAssert" target="_blank">Arrange-Act-Assert</a>” principle for writing the tests.</p><br /><p>The source code for this article can be downloaded from <a href="http://simplecircles.codeplex.com/SourceControl/changeset/changes/057ff59f7d5b" target="_blank">here</a>.</p><br /><p>Next we’ll look at starting an ASP.NET MVC 3 website to consume and present the domain model.</p>