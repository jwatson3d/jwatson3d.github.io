---
layout: post
title: Simple Circles–NHibernate Mapping (Part 7b)
date: '2012-02-03T23:28:00.000-05:00'
author: John Watson
excerpt: In a previous post, I used AutoMapper to implement the DataMapper pattern to map and flatten the domain model into view models for the MVC user interface. The same approach applies to mapping the domain model to a relational database...
tags:
- Patterns
- Tutorial
- NHibernate
- ASP.NET 4.0
- OSS
modified_time: '2012-02-03T23:28:48.738-05:00'
thumbnail: http://lh5.ggpht.com/-so19acv6hmA/Tyyzw4Hh1jI/AAAAAAAAAwA/VRfpiXE314c/s72-c/Simple-Circles---Install-FluentNHibe%25255B2%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-2811308028656623966.post-8714174027223973204
blogger_orig_url: http://pragmatic-software.blogspot.com/2012/02/simple-circlesnhibernate-mapping-part.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">This post is part of a <a href="http://pragmatic-software.blogspot.com/2012/01/simple-circlesintroduction.html">series</a> on building a simple to use web-based contact and customer relationship management application. The goal is to support various audiences including businesses, teams, clubs, religious organizations, etc.<br />In a <a href="http://pragmatic-software.blogspot.com/2012/01/simple-circlesadd-aspnet-mvc-3-ui-part_15.html">previous post</a>, I used <a href="http://automapper.org/" target="_blank">AutoMapper</a> to implement the DataMapper pattern to map and flatten the <a href="http://pragmatic-software.blogspot.com/2012/01/simple-circlesdomain-model-part-1.html">domain model</a> into view models for the MVC user interface. The same approach applies to mapping the domain model to a relational database. In fact, this is the heart of an <a href="http://en.wikipedia.org/wiki/Object-relational_mapping" target="_blank">object-relational mapping</a> (ORM) tool like NHibernate. Originally, NHibernate used XML-based mapping files similar to its Hibernate lineage. More recently, James Gregory’s <a href="http://fluentnhibernate.org/" target="_blank">Fluent NHibernate</a> tool has emerged as a leading alternative with strengths such as supporting the <a href="http://en.wikipedia.org/wiki/Fluent_interface" target="_blank">fluent interface</a> programming style, convention-based mappings, and compile-time checking (a huge time saver).<br /><a href="http://lh5.ggpht.com/-CS9hO4fH7d8/TyyzwiJGd5I/AAAAAAAAAv4/iVU9FN5IsTY/s1600-h/Simple-Circles---Install-FluentNHibe.png"><img align="right" alt="Simple Circles - Install FluentNHibernate" border="0" height="80" src="http://lh5.ggpht.com/-so19acv6hmA/Tyyzw4Hh1jI/AAAAAAAAAwA/VRfpiXE314c/Simple-Circles---Install-FluentNHibe%25255B2%25255D.png?imgmax=800" style="background-image: none; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: inline; float: right; margin: 0px 0px 0px 3px; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="Simple Circles - Install FluentNHibernate" width="157" /></a>After adding Fluent NHibernate <a href="http://nuget.org/packages/FluentNHibernate/1.2.0.712" target="_blank">v1.2.0.712</a> – that version is compiled against the NHibernate version I’m using – I created a <span style="font-family: 'Courier New';">\Maps</span> folder and created the mapping classes. Before diving into the mapping, it’s time to introduce a best practice for managing concurrency and allowing detection of stale objects. By convention, NHibernate supports a special-named property called ‘<span style="font-family: 'Courier New';">Version</span>’ that can be numeric (preferred), a timestamp or a DB timestamp. You can find more information at the NHibernate site or Ayende’s <a href="http://ayende.com/blog/3946/nhibernate-mapping-concurrency" target="_blank">post</a>. In the Circles data model, I’ve got a base Entity class which is a great place to put the Version property so every Entity automatically gets the benefit of optimistic concurrency checking. Here's the mappings for <span style="font-family: 'Courier New';">Party</span> and <span style="font-family: 'Courier New';">PartyType</span>:<br /><pre class="c-sharp" name="code">namespace Circles.NHibernateRepository.Maps<br />{<br />  using Circles.Domain;<br /><br />  using FluentNHibernate.Mapping;<br /><br />  public class PartyMap : ClassMap&lt;Party&gt;<br />  {<br />    public PartyMap()<br />    {<br />      Id(x =&gt; x.PartyId).GeneratedBy.GuidComb();<br />      Version(x =&gt; x.Version);<br />      References(x =&gt; x.PartyType, "TypeId")<br />          .Not.Nullable();<br />      Map(x =&gt; x.PartyName)<br />          .Not.Nullable()<br />          .Length(255)<br />          .Index("ukPartyName");<br />    }<br />  }<br /><br />  public class PartyTypeMap : ClassMap&lt;PartyType&gt;<br />  {<br />    public PartyTypeMap()<br />    {<br />      Id(x =&gt; x.TypeId).GeneratedBy.GuidComb();<br />      Version(x =&gt; x.Version);<br />      Map(x =&gt; x.TypeName)<br />          .Not.Nullable()<br />          .Length(255)<br />          .Index("ukTypeName");<br />    }<br />  }<br />}</pre><br />Line #11 above maps the <span style="font-family: 'Courier New';">Id</span> property to a column called <span style="font-family: 'Courier New';">PartyId</span> and specifies that the <a href="http://nhforge.org/blogs/nhibernate/archive/2009/05/21/using-the-guid-comb-identifier-strategy.aspx" target="_blank">Guid.Comb Identifier Strategy</a> be used to generate new ids. Lines #12 and #13 map the referenced PartyType within a Party by creating a foreign key using <span style="font-family: 'Courier New';">TypeId</span> as the column name.<br /><br />Fluent NHibernate has the ability to not only define mappings but to configure NHibernate using the mappings along with other settings you specify. Using this ability, its also possible to export the configuration to <span style="font-family: 'Courier New';">.hbm.xml</span> files combined with NHibernate’s ability to export .hbm files to SQL DDL. There’s a lot of power packed into the following:<br /><pre class="c-sharp" name="code">namespace NHibernateSchemaExport<br />{<br />  using Circles.NHibernateRepository;<br /><br />  using FluentNHibernate.Cfg;<br />  using FluentNHibernate.Cfg.Db;<br /><br />  using NHibernate.Cfg;<br />  using NHibernate.Tool.hbm2ddl;<br /><br />  class Program<br />  {<br />    static void Main(string[] args)<br />    {<br />      Fluently.Configure()<br />        .Database(SQLiteConfiguration.Standard<br />            .ConnectionString(c =&gt; c.FromConnectionStringWithKey("circlesdb"))<br />            .ShowSql)<br />        .Mappings(m =&gt; m.FluentMappings.AddFromAssemblyOf<partyrepository>()<br />            .ExportTo("."))<br />        .ExposeConfiguration(BuildSchema)<br />        .BuildSessionFactory();<br />    }<br /><br />    static void BuildSchema(Configuration cfg)<br />    {<br />      new SchemaExport(cfg)<br />             .SetOutputFile("CirclesSchema.sql")<br />             .Execute(script: true, export: false, justDrop: false);<br />    }<br />  }<br />}</partyrepository></pre><br />Line #18 shows the <span style="font-family: 'Courier New';">ExportTo()</span> method being using to export the configured mappings to the current directory. Line #19 uses the <span style="font-family: 'Courier New';">ExposeConfiguration()</span> method along with NHibernate’s <span style="font-family: 'Courier New';">SchemaExport()</span> method on line #26 to output the database schema. These techniques give us the ability to “see into” the dynamically generated hbm and sql files.<br /><br />There’s more details in the accompanying change set for this post that can be downloaded <a href="http://simplecircles.codeplex.com/SourceControl/changeset/changes/904993bb0f4d" target="_blank"><strong>here</strong></a>. Next up is implementing the PartyRepository now that NHibernate is configured and the domain-to-database mapping is coming together.</div>