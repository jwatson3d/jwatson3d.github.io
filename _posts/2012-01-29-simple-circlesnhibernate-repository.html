---
title: Simple Circles–NHibernate Repository (Part 7a)
date: '2012-01-29T09:50:00.000-05:00'
author: John Watson
classes: wide
excerpt: I’ve got a decent foundation in place with the domain model, persistence interface defining the repository pattern and a concrete implementation with a fake repository for testing purposes. The fake repository also serves to easily and quickly validate the design...
tags:
- MVC
- Tutorial
- NHibernate
- ASP.NET 4.0
- OSS
modified_time: '2012-01-29T09:53:51.265-05:00'
thumbnail: http://lh5.ggpht.com/-lqi1sYP9JBI/TyVcLRam90I/AAAAAAAAAvw/G2tOq3El1HA/s72-c/Simple%252520Circles%252520-%252520Install%252520NHibernate_thumb%25255B1%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-2811308028656623966.post-1421270469269030940
blogger_orig_url: http://pragmatic-software.blogspot.com/2012/01/simple-circlesnhibernate-repository.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">This post is part of a <a href="http://pragmatic-software.blogspot.com/2012/01/simple-circlesintroduction.html">series</a> on building a simple to use web-based contact and customer relationship management application. The goal is to support various audiences including businesses, teams, clubs, religious organizations, etc.<br />I’ve got a decent foundation in place with the <a href="http://pragmatic-software.blogspot.com/2012/01/simple-circlesdomain-model-part-1.html">domain model</a>, <a href="http://pragmatic-software.blogspot.com/2012/01/simple-circlespersistence-part-2.html">persistence interface</a> defining the repository pattern and a concrete implementation with a <a href="http://pragmatic-software.blogspot.com/2012/01/simple-circlesfake-repository-part-3.html">fake repository</a> for testing purposes. The fake repository also serves to easily and quickly validate the design – if it is difficult to implement with simple in-memory structures then it’ll likely be even harder using an ORM. I have more experience with NHibernate and it’s a more sophisticated and mature ORM so I’ll start with it first.<br />To begin with, I’ve added two interfaces to the Persistence class library to define a database session and a <a href="http://www.dofactory.com/Patterns/PatternAbstract.aspx" target="_blank">factory pattern</a> to manage creating sessions.<br /><pre class="c-sharp" name="code">namespace Circles.Persistence<br />{<br />  using System;<br />  using System.Data;<br /><br />  public interface IDbSession : IDisposable<br />  {<br />    void BeginTransaction(IsolationLevel isolationLevel);<br /><br />    void Commit();<br /><br />    void Rollback();<br /><br />    IPartyRepository CreatePartyRepository();<br />  }<br />}</pre>Bob Cravens provided inspiration for the session work with his <a href="http://blog.bobcravens.com/2010/06/the-repository-pattern-with-linq-to-fluent-nhibernate-and-mysql/" target="_blank">Truck Management System</a>. that eventually made it into his own <a href="https://github.com/rcravens/GenericRepository" target="_blank">GenericRepository</a> project. This database session interface specifies that concrete implementations provide <span style="font-family: 'Courier New';">BeginTransaction</span>, <span style="font-family: 'Courier New';">Commit</span>, and <span style="font-family: 'Courier New';">Rollback</span> methods as well as a concrete implementation for creating a <span style="font-family: 'Courier New';">PartyRepository</span>.<br />The <span style="font-family: 'Courier New';">DbSessionFactory</span> defines the factory pattern with a little bit of flexibility – you can create a <span style="font-family: 'Courier New';">DbSession</span> with or without transactional support.<br /><pre class="c-sharp" name="code">namespace Circles.Persistence<br />{<br />  public interface IDbSessionFactory<br />  {<br />    IDbSession Create(bool withTransaction);<br />  }<br />}</pre><a href="http://lh6.ggpht.com/-UvFkmtPAi0s/TyVcKb6bjcI/AAAAAAAAAvo/tPvx7BVzej8/s1600-h/Simple%252520Circles%252520-%252520Install%252520NHibernate%25255B3%25255D.png"><img align="right" alt="Simple Circles - Install NHibernate" border="0" height="73" src="http://lh5.ggpht.com/-lqi1sYP9JBI/TyVcLRam90I/AAAAAAAAAvw/G2tOq3El1HA/Simple%252520Circles%252520-%252520Install%252520NHibernate_thumb%25255B1%25255D.png?imgmax=800" style="background-image: none; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: inline; float: right; margin: 0px 0px 0px 5px; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="Simple Circles - Install NHibernate" width="191" /></a>Next I created an <span style="font-family: 'Courier New';">NHibernateRepository</span> class library project and added the NHibernate package via NuGet. While NuGet makes it simple to install packages and their dependencies, it doesn’t relieve you from managing versions. It is usually best to specify an explicit version when installing packages to ensure you don’t get conflicts and other surprises. In my case I used “<span style="font-family: 'Courier New';">-version 3.1.0.4000</span>” which also installs the same version of <span style="font-family: 'Courier New';">Iesi.Collections</span>.<br />The implementation of DbSessionFactory is pretty lightweight and trivial:<br /><pre class="c-sharp" name="code">namespace Circles.NHibernateRepository<br />{<br />  using System.Data;<br />  using Circles.Persistence;<br /><br />  public class DbSessionFactory : IDbSessionFactory<br />  {<br />    public IDbSession Create(bool withTransaction)<br />    {<br />      DbSession session = new DbSession(SessionProvider.SessionFactory);<br /><br />      if (withTransaction)<br />      {<br />        session.BeginTransaction(IsolationLevel.ReadCommitted);<br />      }<br /><br />      return session;<br />    }<br />  }<br />}</pre><br />The <span style="font-family: 'Courier New';">SessionProvider</span> class used in line #10 above will be discussed below. <span style="font-family: 'Courier New';">DbSession</span> is also lightweight because it delegates the heavy lifting to the underlying NHibernate methods:<br /><pre class="c-sharp" name="code">namespace Circles.NHibernateRepository<br />{<br />  using System;<br />  using System.Data;<br />  using Circles.Persistence;<br />  using NHibernate;<br /><br />  public class DbSession : IDbSession<br />  {<br />    private readonly ISession session;<br />    private ITransaction transaction;<br /><br />    public DbSession(ISessionFactory sessionFactory)<br />    {<br />      if (sessionFactory == null)<br />      {<br />        throw new ArgumentNullException("sessionFactory");<br />      }<br /><br />      this.session = sessionFactory.OpenSession();<br />      this.session.FlushMode = FlushMode.Auto;<br />    }<br /><br />    ~DbSession()<br />    {<br />      this.Dispose();<br />    }<br /><br />    public void Dispose()<br />    {<br />      if (this.session == null)<br />      {<br />        return;<br />      }<br /><br />      lock (this.session)<br />      {<br />        if (this.session.IsOpen)<br />        {<br />          this.session.Close();<br />        }<br />      }<br /><br />      GC.SuppressFinalize(this);<br />    }<br /><br />    public IPartyRepository CreatePartyRepository()<br />    {<br />      return new PartyRepository(this.session);<br />    }<br /><br />    public void BeginTransaction(IsolationLevel isolationLevel)<br />    {<br />      this.transaction = this.session.BeginTransaction(isolationLevel);<br />    }<br /><br />    public void Commit()<br />    {<br />      if (this.transaction == null)<br />      {<br />        return;<br />      }<br /><br />      if (!this.transaction.IsActive)<br />      {<br />        throw new InvalidOperationException("No active transation");<br />      }<br /><br />      this.transaction.Commit();<br />    }<br /><br />    public void Rollback()<br />    {<br />      if (this.transaction == null)<br />      {<br />        return;<br />      }<br /><br />      if (this.transaction.IsActive)<br />      {<br />        this.transaction.Rollback();<br />      }<br />    }<br />  }<br />}</pre><br />NHibernate is highly configurable so instantiating the libraries requires processing configuration settings contained in <span style="font-family: 'Courier New';">hibernate.cfg.xml</span> as well as reflecting over your assemblies. Doing so is expensive – its best to cache the initialized configuration and session for the lifetime of the application. The <span style="font-family: 'Courier New';">SessionProvider</span> class does this:<br /><pre class="c-sharp" name="code">namespace Circles.NHibernateRepository<br />{<br />  using NHibernate;<br />  using NHibernate.Cfg;<br /><br />  public class SessionProvider<br />  {<br />    private static Configuration configuration;<br /><br />    private static ISessionFactory sessionFactory;<br /><br />    private SessionProvider()<br />    {<br />    }<br /><br />    public static Configuration Configuration<br />    {<br />      get<br />      {<br />        if (configuration == null)<br />        {<br />          configuration = new Configuration();<br />          configuration.Configure();<br />          configuration.AddAssembly(typeof(PartyRepository).Assembly);<br />        }<br /><br />        return configuration;<br />      }<br />    }<br /><br />    public static ISessionFactory SessionFactory<br />    {<br />      get { return sessionFactory <br />              ?? (sessionFactory = Configuration.BuildSessionFactory()); }<br />    }<br /><br />    public static ISession GetSession()<br />    {<br />      return SessionFactory.OpenSession();<br />    }<br />  }<br />}</pre><br />That’s a lot of implementation and setup plumbing! The source code for this article can be downloaded from <a href="http://simplecircles.codeplex.com/SourceControl/changeset/changes/892d3eae3db5" target="_blank">here</a>. The next installment will map the domain model to the relational database model.</div>
