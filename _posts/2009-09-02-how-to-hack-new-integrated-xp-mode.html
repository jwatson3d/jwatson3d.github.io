---

title: How To Hack a New Integrated XP Mode Application
date: '2009-09-02T13:35:00.001-04:00'
author: John
tags:
- Virtualization
- Win7
modified_time: '2010-09-05T14:48:45.025-04:00'
thumbnail: http://lh4.ggpht.com/_BvH8o_BvG-4/TIJdPWSk19I/AAAAAAAAADI/_0xXB7HSlyQ/s72-c/TsAppAllowList_thumb1.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-2811308028656623966.post-2076772523841350391
blogger_orig_url: http://pragmatic-software.blogspot.com/2009/09/how-to-hack-new-integrated-xp-mode.html
---

<div style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; float: none; padding-top: 0px" id="scid:0767317B-992E-4b12-91E0-4F059A8CECA8:c97f4cba-873a-4f53-8e8f-3791e1e00083" class="wlWriterEditableSmartContent">Technorati Tags: <a href="http://technorati.com/tags/win7" rel="tag">win7</a>,<a href="http://technorati.com/tags/xpmode" rel="tag">xpmode</a>,<a href="http://technorati.com/tags/virtual" rel="tag">virtual</a>,<a href="http://technorati.com/tags/eclipse" rel="tag">eclipse</a></div><p>One thing I discovered about integrated applications is that only Windows installer-based applications will be “exported” from the XP Mode machine to the Windows 7 host. I decided to install the new Eclipse 4.5 release under (in?) XP Mode and it runs great there. Since I wanted to also have the nifty application shortcut on the Windows 7 start menu I looked around the ‘verse for how to do that but couldn’t find anything. I already had a few applications “exported” that way so I decided to try and hack the appropriate links together to make it work. Here’s the steps necessary to make it happen:</p><ol><li>Manually register the application in the Terminal Services Application Allowed List.<br /><li>Extract an icon (optional) to put on Windows 7 shortcut.<br /><li>Manually create the shortcut on Windows 7. </li><br /></ol><p>Note: These steps are (obviously) completely unsupported by Microsoft and have received limited testing. OK, I really only got this one application to work on one machine :) so use at your own risk!</p><p><font size="4"><strong>Register the Application</strong></font></p><p>Within the running XP Mode instance, you need to add entries in the registry under <strong><em>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Terminal Server\TsAppAllowList\Applications</em></strong> which appear to contain enough information to “auto-launch” the requested application. Here’s a screenshot of the entries I created for Eclipse:</p><p><a href="http://lh4.ggpht.com/_BvH8o_BvG-4/TIJdOjWrWwI/AAAAAAAAADE/ECINa-4ySr8/s1600-h/TsAppAllowList3.png"><img style="border-right-width: 0px; margin: 5px 0px 0px 5px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="TsAppAllowList" border="0" alt="TsAppAllowList" align="right" src="http://lh4.ggpht.com/_BvH8o_BvG-4/TIJdPWSk19I/AAAAAAAAADI/_0xXB7HSlyQ/TsAppAllowList_thumb1.png?imgmax=800" width="244" height="152"></a> </p><p></p><p>Note the random key name, “<strong>cfc5bae5</strong>”, which I made up. By looking at other entries, I was able to create all the necessary values. One thing I did to be “safe” was to open a command prompt and use “dir /x” to ensure the short path name was correct. In the case of Eclipse it is only seven characters long so Windows doesn’t have to mangle the name to shorten it into “8.3” format. If you look at other applications registered there, you’ll see what I mean.</p><p><font size="4"><strong>Extract the Icon</strong></font></p><p>Since the Eclipse executable has its icon embedded within as do most Windows applications, I used the free <a href="http://www.nirsoft.net/utils/iconsext.html" target="_blank">IconsExtract utility</a> from NirSoft to extract out the embedded icon and save it as an .ico file:</p><p><a href="http://lh4.ggpht.com/_BvH8o_BvG-4/TIJdPoaDDDI/AAAAAAAAADM/QmuLiiTUnJY/s1600-h/Eclipse_icon_extract12.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Eclipse_icon_extract1" border="0" alt="Eclipse_icon_extract1" src="http://lh5.ggpht.com/_BvH8o_BvG-4/TIJdPp4oRwI/AAAAAAAAADQ/ca5o6LAzTos/Eclipse_icon_extract1_thumb.png?imgmax=800" width="244" height="184"></a> <a href="http://lh6.ggpht.com/_BvH8o_BvG-4/TIJdP-nkJ0I/AAAAAAAAADU/QMUmEOYC3Io/s1600-h/Eclipse_icon_extract22.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Eclipse_icon_extract2" border="0" alt="Eclipse_icon_extract2" src="http://lh5.ggpht.com/_BvH8o_BvG-4/TIJdQskcLKI/AAAAAAAAADY/J3_-71qiI_Y/Eclipse_icon_extract2_thumb.png?imgmax=800" width="244" height="134"></a> </p><p>I then copied the extracted icon file out to the Windows 7 host drive using the default mapped drive letter automatically created for XP Mode.</p><p>At this point, I shut down the running XP Mode instance using the Windows Security link on its Start Menu. Simply closing the window or using Log Off leaves the virtual machine running and I wanted to be sure the test would work from a “cold start”.</p><p></p><p><font size="4"><strong>Manually Create Shortcut on Windows 7</strong></font></p><p>The machine-wide Start Menu shortcuts for Windows 7 are stored under <strong><em>%SYSTEMDRIVE%\ProgramData\Microsoft\Windows\Start Menu</em></strong> but you’ll only find the Windows Virtual PC and Windows XP Mode links there. Instead, all the application shortcuts are stored under your user profile’s roaming settings -<strong><em> %APPDATA%\Microsoft\Windows\Start Menu\Programs\Windows Virtual PC\Windows XP Mode Applications</em></strong> where %APPDATA% typically resolves to <strong><em>C:\Users\{yourLoginName}\AppData\Roaming\</em></strong>. If you look at the properties of an existing shortcut that was automatically exported you’ll find something like this one for Notepad++:</p><p><strong><em><font face="Courier New">%SystemRoot%\system32\rundll32.exe %SystemRoot%\system32\VMCPropertyHandler.dll,LaunchVMSal "Windows XP Mode" "||6cab7fc4" "Notepad++"</font></em></strong> </p><p><a href="http://lh3.ggpht.com/_BvH8o_BvG-4/TIJdQ3GBMcI/AAAAAAAAADc/p12eOREPXoE/s1600-h/Eclipse_virtual_icon3.png"><img style="border-right-width: 0px; margin: 5px 0px 0px 5px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Eclipse_virtual_icon" border="0" alt="Eclipse_virtual_icon" align="right" src="http://lh3.ggpht.com/_BvH8o_BvG-4/TIJdRm0CKBI/AAAAAAAAADg/-7Y45vwYvdI/Eclipse_virtual_icon_thumb1.png?imgmax=800" width="244" height="101"></a>After examining a couple of these, it became apparent that the key piece of information is the random string of hex characters embedded after the double pipes, i.e. “||6cab7fc4”. This string value corresponds to the registry key name within the XP Mode virtual machine from step one. Now it was simply a matter to copy|paste one of the existing shortcuts, change the name and the embedded string and select the application icon previously exported and copied out to Windows 7.<a href="http://lh5.ggpht.com/_BvH8o_BvG-4/TIJdR3ePxvI/AAAAAAAAADk/Sk7GHpHCQPc/s1600-h/Eclipse_shortcut3.png"><img style="border-right-width: 0px; margin: 5px 0px 5px 5px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Eclipse_shortcut" border="0" alt="Eclipse_shortcut" align="right" src="http://lh4.ggpht.com/_BvH8o_BvG-4/TIJdSuGDGLI/AAAAAAAAADo/6TvwSo3KaCc/Eclipse_shortcut_thumb1.png?imgmax=800" width="244" height="100"></a> </p><p>Looking at the other shortcut entries I learned that the icons are stored under <strong><em>%LOCALAPPDATA%\Microsoft\Windows Virtual PC\Virtual Applications\Windows XP Mode</em></strong> where %LOCALAPPDATA% typically resolves to <strong><em>C:\Users\{yourLoginName}\AppData\Local\</em></strong>. </p><p></p><p></p><p></p><p></p><p></p><p><a href="http://lh5.ggpht.com/_BvH8o_BvG-4/TIJdS6q3V0I/AAAAAAAAADs/t8V24kFFFMQ/s1600-h/Eclipse_shortcut_properties3.png"><img style="border-right-width: 0px; margin: 5px 0px 5px 5px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="Eclipse_shortcut_properties" border="0" alt="Eclipse_shortcut_properties" align="right" src="http://lh3.ggpht.com/_BvH8o_BvG-4/TIJdTO_AFSI/AAAAAAAAADw/aHM2K_DZOm0/Eclipse_shortcut_properties_thumb1.png?imgmax=800" width="202" height="244"></a>Here is the finished shortcut properties with the Eclipse icon showing the embedded string. Notice the indicated string value matches the random set of characters I chose in step one when creating the registry key in the XP Mode virtual machine.</p><p>I’ve listed the steps in order from “inside out” – that is, from inside the virtual machine out to the Windows 7 host machine. However, the truth of the matter is that I worked backwards from outside in to figure it out. I first examined and compared a few existing Windows 7 shortcuts to realize that the string value played an important part – except for the application name, the rest of the shortcut commands were identical. I then fired up the XP Mode virtual machine and went right to the registry editor to search for one of those strings and hit pay dirt – I found the configuration within that contained all the necessary information to launch the application. The only piece left was a bit of polish to extract the icon so I could use it in Windows 7. Again, looking at other existing shortcuts I found where the application launch icons were stored and put the new one there.</p>